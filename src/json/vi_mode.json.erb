{
    "title": "Vi Mode (rev 4.2)",
    "rules": [
        {
            "description": "Vi Mode [S as Trigger Key]",
            "manipulators": [

                <%# -------------------------------------------------- %>
                <%# press s to enter Vi Mode, release to quit %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("s", [], ["caps_lock"]) %>,
                    "to": [
                        { "set_variable": { "name": "vi_mode", "value": 1 } }
                    ],
                    "to_if_alone": <%= to([["s"]]) %>,
                    "to_after_key_up": [
                        { "set_variable": { "name": "vi_mode", "value": 0 } }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# change h/j/k/l to arrow keys %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("h", [], ["caps_lock"]) %>,
                    "to": <%= to([["left_arrow"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("j", [], ["caps_lock"]) %>,
                    "to": <%= to([["down_arrow"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("k", [], ["caps_lock"]) %>,
                    "to": <%= to([["up_arrow"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("l", [], ["caps_lock"]) %>,
                    "to": <%= to([["right_arrow"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# change f to fn %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("f", [], ["caps_lock"]) %>,
                    "to": <%= to([["fn"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# change fn + h/j/k/l to home/page_down/page_up/end %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("h", ["fn"], ["caps_lock"]) %>,
                    "to": <%= to([["home"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("j", ["fn"], ["caps_lock"]) %>,
                    "to": <%= to([["page_down"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("k", ["fn"], ["caps_lock"]) %>,
                    "to": <%= to([["page_up"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("l", ["fn"], ["caps_lock"]) %>,
                    "to": <%= to([["end"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# change 0/4 to control + a/e (go to start/end of line) %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("0", [], ["caps_lock"]) %>,
                    "to": <%= to([["a", ["left_control"]], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("4", [], ["caps_lock", "shift"]) %>,
                    "to": <%= to([["e", ["left_control"]], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# press v to enter visual mode, release to quit %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("v", [], ["caps_lock"]) %>,
                    "to": [
                        { "set_variable": { "name": "vi_visual_mode", "value": 1 } }
                    ],
                    "to_if_alone": <%= to([["vk_none"]]) %>,
                    "to_after_key_up": [
                        { "set_variable": { "name": "vi_visual_mode", "value": 0 } }
                    ],
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# use h/j/k/l to select text in visual mode %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("h", [], ["caps_lock"]) %>,
                    "to": <%= to([["left_arrow", ["left_shift"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("j", [], ["caps_lock"]) %>,
                    "to": <%= to([["down_arrow", ["left_shift"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("k", [], ["caps_lock"]) %>,
                    "to": <%= to([["up_arrow", ["left_shift"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("l", [], ["caps_lock"]) %>,
                    "to": <%= to([["right_arrow", ["left_shift"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# use 0/4 to select until start/end of line in visual mode %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("0", [], ["caps_lock"]) %>,
                    "to": <%= to([["left_arrow", ["left_shift", "left_command"]], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("4", [], ["caps_lock", "shift"]) %>,
                    "to": <%= to([["right_arrow", ["left_shift", "left_command"]], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# use b/w to select until start/end of word in visual mode %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("b", [], ["caps_lock"]) %>,
                    "to": <%= to([["left_arrow", ["left_shift", "left_option"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("w", [], ["caps_lock"]) %>,
                    "to": <%= to([["right_arrow", ["left_shift", "left_option"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# use open/close bracket to select until start/end of paragraph in visual mode %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("open_bracket", [], ["caps_lock", "shift"]) %>,
                    "to": <%= to([["up_arrow", ["left_shift", "left_option"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("close_bracket", [], ["caps_lock", "shift"]) %>,
                    "to": <%= to([["down_arrow", ["left_shift", "left_option"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# drop other keys in visual mode %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": {
                        "any": "key_code",
                        "modifiers": { "optional": [ "any" ] }
                    },
                    "to": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# normalize return, space & tab %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("return_or_enter", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["return_or_enter"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("spacebar", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["spacebar"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("tab", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["tab"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# normalize punctuation marks %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("hyphen", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["hyphen"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("equal_sign", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["equal_sign"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("open_bracket", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["open_bracket"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("close_bracket", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["close_bracket"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("backslash", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["backslash"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("non_us_pound", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["non_us_pound"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("semicolon", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["semicolon"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("quote", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["quote"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("grave_accent_and_tilde", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["grave_accent_and_tilde"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("comma", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["comma"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("period", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["period"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("slash", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["slash"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("non_us_backslash", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["non_us_backslash"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# normalize number keys (except for 0, 4) %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("1", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["1"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("2", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["2"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("3", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["3"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("5", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["5"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("6", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["6"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("7", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["7"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("8", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["8"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("9", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["9"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# normalize letter keys (except for h, j, k, l, s, f, v) %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("a", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["a"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("b", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["b"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("c", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["c"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("d", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["d"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("e", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["e"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("g", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["g"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("i", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["i"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("m", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["m"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("n", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["n"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("o", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["o"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("p", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["p"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("q", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["q"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("r", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["r"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("t", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["t"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("u", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["u"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("w", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["w"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("x", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["x"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("y", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["y"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("z", [], ["caps_lock"]) %>,
                    "to": <%= to([["s"], ["z"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                }
            ]
        },

        {
            "description": "Vi Mode [D as Trigger Key] (recommended)",
            "manipulators": [

                <%# -------------------------------------------------- %>
                <%# press d to enter Vi Mode, release to quit %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("d", [], ["caps_lock"]) %>,
                    "to": [
                        { "set_variable": { "name": "vi_mode", "value": 1 } }
                    ],
                    "to_if_alone": <%= to([["d"]]) %>,
                    "to_after_key_up": [
                        { "set_variable": { "name": "vi_mode", "value": 0 } }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# change h/j/k/l to arrow keys %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("h", [], ["caps_lock"]) %>,
                    "to": <%= to([["left_arrow"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("j", [], ["caps_lock"]) %>,
                    "to": <%= to([["down_arrow"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("k", [], ["caps_lock"]) %>,
                    "to": <%= to([["up_arrow"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("l", [], ["caps_lock"]) %>,
                    "to": <%= to([["right_arrow"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# change f to fn %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("f", [], ["caps_lock"]) %>,
                    "to": <%= to([["fn"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# change fn + h/j/k/l to home/page_down/page_up/end %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("h", ["fn"], ["caps_lock"]) %>,
                    "to": <%= to([["home"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("j", ["fn"], ["caps_lock"]) %>,
                    "to": <%= to([["page_down"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("k", ["fn"], ["caps_lock"]) %>,
                    "to": <%= to([["page_up"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("l", ["fn"], ["caps_lock"]) %>,
                    "to": <%= to([["end"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# change 0/4 to control + a/e (go to start/end of line) %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("0", [], ["caps_lock"]) %>,
                    "to": <%= to([["a", ["left_control"]], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("4", [], ["caps_lock", "shift"]) %>,
                    "to": <%= to([["e", ["left_control"]], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 },
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 0 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# press v to enter visual mode, release to quit %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("v", [], ["caps_lock"]) %>,
                    "to": [
                        { "set_variable": { "name": "vi_visual_mode", "value": 1 } }
                    ],
                    "to_if_alone": <%= to([["vk_none"]]) %>,
                    "to_after_key_up": [
                        { "set_variable": { "name": "vi_visual_mode", "value": 0 } }
                    ],
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# use h/j/k/l to select text in visual mode %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("h", [], ["caps_lock"]) %>,
                    "to": <%= to([["left_arrow", ["left_shift"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("j", [], ["caps_lock"]) %>,
                    "to": <%= to([["down_arrow", ["left_shift"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("k", [], ["caps_lock"]) %>,
                    "to": <%= to([["up_arrow", ["left_shift"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("l", [], ["caps_lock"]) %>,
                    "to": <%= to([["right_arrow", ["left_shift"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# use 0/4 to select until start/end of line in visual mode %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("0", [], ["caps_lock"]) %>,
                    "to": <%= to([["left_arrow", ["left_shift", "left_command"]], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("4", [], ["caps_lock", "shift"]) %>,
                    "to": <%= to([["right_arrow", ["left_shift", "left_command"]], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# use b/w to select until start/end of word in visual mode %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("b", [], ["caps_lock"]) %>,
                    "to": <%= to([["left_arrow", ["left_shift", "left_option"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("w", [], ["caps_lock"]) %>,
                    "to": <%= to([["right_arrow", ["left_shift", "left_option"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# use open/close bracket to select until start/end of paragraph in visual mode %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("open_bracket", [], ["caps_lock", "shift"]) %>,
                    "to": <%= to([["up_arrow", ["left_shift", "left_option"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("close_bracket", [], ["caps_lock", "shift"]) %>,
                    "to": <%= to([["down_arrow", ["left_shift", "left_option"]]]) %>,
                    "to_after_key_up": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# drop other keys in visual mode %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": {
                        "any": "key_code",
                        "modifiers": { "optional": [ "any" ] }
                    },
                    "to": <%= to([["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_visual_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# normalize return, space & tab %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("return_or_enter", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["return_or_enter"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("spacebar", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["spacebar"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("tab", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["tab"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# normalize punctuation marks %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("hyphen", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["hyphen"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("equal_sign", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["equal_sign"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("open_bracket", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["open_bracket"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("close_bracket", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["close_bracket"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("backslash", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["backslash"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("non_us_pound", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["non_us_pound"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("semicolon", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["semicolon"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("quote", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["quote"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("grave_accent_and_tilde", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["grave_accent_and_tilde"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("comma", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["comma"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("period", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["period"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("slash", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["slash"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("non_us_backslash", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["non_us_backslash"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# normalize number keys (except for 0, 4) %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("1", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["1"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("2", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["2"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("3", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["3"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("5", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["5"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("6", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["6"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("7", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["7"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("8", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["8"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("9", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["9"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },

                <%# -------------------------------------------------- %>
                <%# normalize letter keys (except for h, j, k, l, d, f, v) %>
                <%# -------------------------------------------------- %>
                {
                    "type": "basic",
                    "from": <%= from("a", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["a"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("b", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["b"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("c", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["c"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("e", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["e"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("g", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["g"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("i", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["i"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("m", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["m"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("n", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["n"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("o", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["o"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("p", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["p"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("q", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["q"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("r", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["r"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("s", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["s"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("t", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["t"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("u", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["u"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("w", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["w"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("x", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["x"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("y", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["y"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                },
                {
                    "type": "basic",
                    "from": <%= from("z", [], ["caps_lock"]) %>,
                    "to": <%= to([["d"], ["z"], ["vk_none"]]) %>,
                    "conditions": [
                        { "type": "variable_if", "name": "vi_mode", "value": 1 }
                    ]
                }
            ]
        }
    ]
}
